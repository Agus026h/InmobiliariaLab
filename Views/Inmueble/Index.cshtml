@model IEnumerable<devs.Models.Inmueble>

@{
    ViewData["Title"] = "Inmuebles";
    
    var DireccionFiltro = ViewBag.DireccionFiltro;
    var NombrePropietarioFiltro = ViewBag.NombrePropietarioFiltro;

    var UsoFiltro = ViewBag.UsoFiltro as string; 
    var EstadoFiltro = ViewBag.EstadoFiltro as string;
    bool isDisponibilidadSearch = ViewBag.IsDisponibilidadSearch ?? false;
    
    var usos = Enum.GetValues(typeof(devs.Models.UsoInmueble)).Cast<devs.Models.UsoInmueble>();
    var estados = Enum.GetValues(typeof(devs.Models.EstadoInmueble)).Cast<devs.Models.EstadoInmueble>();
}

<h1>Listado de Inmuebles</h1>

<p>
    <a asp-action="Crear" class="btn btn-success">Crear Nuevo Inmueble</a>
</p>
<form method="get" asp-action="Index" class="mb-4 p-3 border rounded bg-info-subtle shadow-sm">
    <div class="row align-items-end">
        <div class="col-md-5">
            <label for="fechaConsultaInicio" class="form-label fw-bold">Disponible Desde:</label>
            <input type="date" 
                   class="form-control" 
                   name="fechaConsultaInicio" 
                   id="fechaConsultaInicio" 
                   value="@(Context.Request.Query["fechaConsultaInicio"])" 
                   required>
        </div>
        <div class="col-md-5">
            <label for="fechaConsultaFin" class="form-label fw-bold">Disponible Hasta:</label>
            <input type="date" 
                   class="form-control" 
                   name="fechaConsultaFin" 
                   id="fechaConsultaFin" 
                   value="@(Context.Request.Query["fechaConsultaFin"])" 
                   required>
        </div>
        <div class="col-md-2 d-flex align-items-end">
             <button type="submit" class="btn btn-info text-white w-100">
                 <i class="fa-solid fa-calendar-check"></i> Consultar
             </button>
        </div>
    </div>
</form>
@if (isDisponibilidadSearch)
{
   
    <h3 class="text-success mt-4">
        Inmuebles Disponibles (@ViewBag.TotalRegistrosDisponibles)
    </h3>
    <p>Mostrando resultados para el período del **@ViewBag.FechaConsultaInicio** al **@ViewBag.FechaConsultaFin**.</p>
    
    <a asp-action="Index" class="btn btn-secondary mb-3">
        <i class="fa-solid fa-list"></i> Volver a Listado Normal
    </a>
    
    <div id="tablaInmuebles">
       
        @await Html.PartialAsync("_TablaInmueblesPartial", Model)
    </div>
}
else
{

<form id="filtroForm">
    <div class="row mb-3">
        
        <div class="col-md-3">
            <label for="direccionFiltro" class="form-label">Dirección:</label>
            <input type="text" class="form-control" id="direccionFiltro" name="direccion" 
                   value="@DireccionFiltro" placeholder="Buscar dirección">
        </div>
        
        <div class="col-md-3">
            <label for="usoFiltro" class="form-label">Uso:</label>
            <select class="form-select" id="usoFiltro" name="uso">
                <option value="">Todos</option>
                @foreach (var uso in usos)
                {
                    <option 
                        value="@((int)uso)" 
                        selected ="@(UsoFiltro == ((int)uso).ToString())">
                        @uso.ToString()
                    </option>
                }
            </select>
        </div>
        
        <div class="col-md-3">
            <label for="estadoFiltro" class="form-label">Estado:</label>
            <select class="form-select" id="estadoFiltro" name="estado">
                <option value="">Todos</option>
                @foreach (var estado in estados)
                {
                    <option 
                        value="@((int)estado)" 
                        selected ="@(EstadoFiltro == ((int)estado).ToString())"> 
                        @estado.ToString()
                    </option>
                
                }
            </select>
        </div>
        
        <div class="col-md-3">
            <label for="nombrePropietarioFiltro" class="form-label">Propietario (Nombre/Apellido):</label>
            <input type="text" class="form-control" id="nombrePropietarioFiltro" name="nombrePropietario" 
                   value="@NombrePropietarioFiltro" placeholder="Escriba nombre o apellido">
        </div>
        
    </div>
    
    <div class="row mb-3">
        <div class="col-md-12 text-end">
             <button type="submit" class="btn btn-primary">Buscar</button>
        </div>
    </div>
</form>

<hr/>

<div id="tablaInmuebles">
    @await Html.PartialAsync("_TablaInmueblesPartial", Model)
</div>
}
<div class="modal fade" id="reservaModal" tabindex="-1" aria-labelledby="reservaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reservaModalLabel">Crear Contrato de Reserva Rápida</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalContent">
                
                <div class="text-center p-5">Cargando...</div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
    var reservaModalInstance = null; 
    $(document).ready(function(){
        const reservaModalElement = document.getElementById('reservaModal');
        if (reservaModalElement) {
            
            reservaModalInstance = new bootstrap.Modal(reservaModalElement);
        }

        function cargarTabla(url){
            
             $("#tablaInmuebles").html('<p class="text-center">Cargando inmuebles...</p>');
            $.ajax({
                url: url,
                type: "GET",
                headers: { 'X-Requested-With': 'XMLHttpRequest' }, 
                success: function(data){
                    $("#tablaInmuebles").html(data);
                    history.pushState(null, '', url); 
                },
                error: function(xhr, status, error){
                    $("#tablaInmuebles").html('<p class="text-danger text-center">Error al cargar los datos: '+ error+ '</p>');
                }
            });
        }

        $(document).on("click", "#tablaInmuebles a.page-link", function(e){
            e.preventDefault();
            var url = $(this).attr("href");
            cargarTabla(url);
        });
        $(document).on("click", ".btn-reservar", function() {
        var btn = $(this);
        var idInmueble = btn.data('id-inmueble');
        var direccion = btn.data('direccion');
        var precio = btn.data('precio');
        var fechaInicio = btn.data('fecha-inicio');
        var fechaFin = btn.data('fecha-fin');
        
       
        $('#modalContent').html('<div class="text-center p-5"><i class="fa-solid fa-spinner fa-spin fa-2x"></i> Cargando formulario...</div>');

        
        $.ajax({
            url: '@Url.Action("CrearReservaRapida", "Contrato")', 
            type: 'GET',
            data: {
                idInmueble: idInmueble,
                direccion: direccion,
                precio: precio,
                fechaInicio: fechaInicio,
                fechaFin: fechaFin
            },
            success: function(data) {
               
                $('#modalContent').html(data);
                
                
                if (reservaModalInstance) {
                        reservaModalInstance.show();
                    } else {
                        
                        console.error("Error: Instancia de Modal no encontrada.");
                    }
              
            },
            error: function(xhr, status, error) {
                $('#modalContent').html('<div class="alert alert-danger">Error al cargar el formulario de reserva: ' + error + '</div>');
            }
        });
    });

        $("#filtroForm").on("submit", function (e) {
            e.preventDefault(); 
            
            var direccion = $("#direccionFiltro").val() || "";
            var uso = $("#usoFiltro").val() || ""; 
            var estado = $("#estadoFiltro").val() || ""; 
            var nombrePropietario = $("#nombrePropietarioFiltro").val() || ""; 
            
            var url = '@Url.Action("Index", "Inmueble")';
           
            url += `?pagina=1&direccion=${direccion}&uso=${uso}&estado=${estado}&nombrePropietario=${nombrePropietario}`; 
            
            cargarTabla(url);
        });
    });
    </script>
}